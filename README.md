# 🖼️ 随机图片 (Random Image)

[![Version](https://img.shields.io/badge/version-v5.7.1-blue.svg)](https://github.com/YourUsername/astrbot_plugin_endworld_img_api) [![License](https://img.shields.io/badge/license-GPLv3-green.svg)](LICENSE) [![AstrBot](https://img.shields.io/badge/AstrBot-%3E%3D4.11.4-orange.svg)](https://github.com/Soulter/AstrBot) [![Python](https://img.shields.io/badge/python-3.11%2B-blue.svg)](https://www.python.org/)

一个为 AstrBot 打造的自定义 API 获取随机图片分发插件。
本插件从原 [(https://github.com/MCYUNIDC/mccloud_img)](https://github.com/MCYUNIDC/mccloud_img) 分支派生，经历了彻底的底层重构，从单一的图片获取工具，进化为**支持多指令分流、合并转发防吞、精细化分群管理、阅后即焚与安全防护**的高级图片引擎。

<img width="1408" height="768" alt="image_602ec539-0c6a-426f-877a-8dcd374be08c" src="https://github.com/user-attachments/assets/8a5c7712-ff32-44d3-b051-7b881f3e16a2" />

## 🌟 功能特点一览

*   **🌐 全能 API 兼容**：内置智能 JSON 寻址算法，自动提取真实图片地址；完美兼容 302 跳转直链与纯图片流。
*   **🎛️ 强大的 Web 可视化配置**：基于 AstrBot 最新架构，在后台只需点击“添加”，即可轻松配置多组指令与 API。
*   **🛡️ 分群黑白名单**：单个图源独立管控，黑名单绝不响应，白名单专属特供。
*   **📦 合并转发伪装兜底**：图片发送支持开启合并转发；而**兜底的源站直链将被强制转为合并转发消息**，最大程度保护群聊生态安全。
*   **👻 双重自动撤回机制**：向撤回失败说再见。绕过封装直达底层协议，发送与撤回如丝般顺滑。
*   **⚡ 自动压缩防超时**：内置 `Pillow` 引擎，自定义“压缩阈值”，突破 QQ 协议端大图发不出的瓶颈。
*   **🐱 趣味猫娘模式**：开启互动开关，所有提示文本末尾自动追加自定义后缀词（如“喵~”）。

---

## 📦 安装方法

1. 下载插件代码压缩包，解压后重命名文件夹为 `astrbot_plugin_endworld_img_api`。
2. 将文件夹放置于 AstrBot 的 `data/plugins/` 目录下。
3. 安装该插件必需的依赖库（在终端运行）：
   ```bash
   pip install aiofiles aiohttp Pillow
   ```
   *(或者直接使用插件目录下的 `requirements.txt` 自动安装)*
4. 重启 AstrBot 即可自动加载并在 Web 面板生成高级配置项。

---

## 🚀 使用说明 & 配置指南

### 1. 添加与管理图源
进入 AstrBot 管理后台 -> 插件配置 -> 找到 `astrbot_plugin_endworld_img_api`。
* 点击 **“添加 图源配置”**。
* **规则名称**：随意命名，如“优质壁纸”。
* **触发指令**：输入你想要的触发词，多个请分行或使用列表（如 `壁纸`, `来点图`）。
* **API 地址**：输入对应的 API 链接，插件会按顺序尝试。
* **使用合并转发发送**：勾选后，该图源的图片将以合并转发卡片的形式发出，有效防吞。*(注：失败时的兜底直链默认强制合并转发，不受此开关限制)*
* **分群管理**：按需下拉选择 `无限制`、`黑名单` 或 `白名单`，并填入适用的 QQ 群号列表。
* **自动撤回时间**：填入 `30` 即代表 30秒后撤回；填 `0` 则永久保留。

### 2. 用户日常交互
* 群员发送后台配置的触发词（如 `涩涩`）。
* 若配置了撤回，机器人会先发图，并紧跟一条提示：“图片将在 X 秒后自动撤回喵~”。
* 倒计时结束，图片与提示瞬间消失。

---

## ⚙️ 核心全局配置项解析

| 配置项 | 默认值 | 说明 |
| :--- | :--- | :--- |
| **开启猫娘模式** | `false` | 开启后，机器人的所有文字提示将加上设定的后缀。 |
| **猫娘模式后缀词** | `喵~` | 配合猫娘模式使用，可自定义（如 `哒!`、`主人~`）。 |
| **发送失败重试次数** | `3` | 发送遇到网络波动时重试的次数，耗尽后将强制合并转发原图直链。 |
| **开启大图自动压缩** | `true` | 是否允许插件压缩超大图片以保证发送成功率。 |
| **压缩阈值 (MB)** | `5` | 图片体积大于此值才会触发压缩。想强制发原图可设为 `50`。 |
| **压缩质量 (1-100)** | `85` | 触发压缩时的图片质量，推荐 75-85 之间。 |
| **全局冷却时间 (秒)** | `10` | 限制单个用户连续请求的频率，防止刷屏。 |
| **验证 SSL 证书** | `true` | ⚠️ **强烈建议保持开启**，防止中间人攻击；仅当 API 使用自签名证书报错时关闭。 |

---

## ⚠️ 注意事项 & 提示

* **缓存清理机制**：图片下载后暂存于 `data/temp_images/` 目录下，程序会在发送流程结束后 15 秒自动执行无痕删除，保障硬盘空间。
* **直链兜底防风控机制**：当你看到机器人发出名为“图片分发中心”的聊天记录卡片，且里面写着 `图片遭屏蔽发送失败，为您提供原图直链：...` 时，说明底层协议端发送图片失败。插件为了**保护当前群聊不被腾讯风控**，主动将外部链接包装成了安全的合并转发消息。
* **撤回兼容性**：自动撤回依赖于您部署的底层协议端（如 NapCat / LLOneBot）是否支持并开放了对应 API，若日志提示找不到撤回方法，请更新您的适配器协议端。
* **法律警告**：本插件仅作为网络图片 API 的分发与转发工具。**请遵守相关法律法规，严禁在公开群聊对接与传播非法、违禁的图片源。使用者需自行承担因图源配置不当引发的封号或法律风险。**

---

## 📝 更新日志 (Changelog)

*   **v5.7.1**
    *   🛡️ **风控安全大升级：发送图片失败后的兜底直链更改为【强制合并转发】，彻底解决群内直发外部链接导致群聊被风控或封号的风险。**
    *   ✨ 新增独立图源【合并转发发送】选项，允许用户将正常图片也包装在聊天记录卡片中发出，极大降低图片被平台吞没的概率。
    *   ♻️ 优化核心架构，回归极致轻量与高可用的安全兜底策略。
*   **v5.6** 
    *   ✨ 新增【猫娘模式】，支持自定义所有提示文本的后缀词。
    *   🚀 升级【双重撤回】机制，图片与撤回提示倒计时结束后将同步销毁。
*   **v5.3 - v5.5**
    *   🐛 修复顶层框架无法获取 `message_id` 导致撤回失败的问题，改为绕过框架直达底层协议（适配 NapCat/LLOneBot 等），实现 100% 稳定的自动撤回。
*   **v5.0 - v5.2** 
    *   🛡️ 安全性强化：新增防 SSRF 注入、防 OOM 内存溢出、修复内存泄露隐患。
    *   ✨ 新增下拉式黑/白名单群组管控功能。
    *   ✨ 首次引入自动撤回（阅后即焚）功能。
*   **v4.8 - v4.9** 
    *   🔁 新增发送失败自动重试机制。
    *   🌐 新增兜底方案：多次发送失败后自动转为发送原图直链文本。
*   **v4.0 - v4.7** 
    *   🚀 底层架构大重构：引入 `template_list` 实现 WebUI 多图源动态配置。
    *   🖼️ 新增本地缓存发送机制，解决防盗链与吞图问题。
    *   🗜️ 引入 `Pillow` 引擎，实现大图自动压缩防超时功能。
*   **v1.0** 
    *   🐣 初始基础版本（由原 `mccloud_img` 演进衍生）。

---

## 🛠️ 开发维护

* **版本号**：v5.7.1 (Pro Edition)
* **衍生自**：[mccloud_img](https://github.com/MCYUNIDC/mccloud_img) (Author: MC云)
* **当前重构作者**：殇之冥歌
* **核心依赖**：`AstrBot Core v4.11.4+`

🎉 **Enjoy your high-quality random images!** 🌸
