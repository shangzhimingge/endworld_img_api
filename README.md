# 🖼️ 随机图片 (Random Image)

一个为AstrBot打造的自定义API获取随机图片分发插件。
本插件从原 (https://github.com/MCYUNIDC/mccloud_img) 分支派生，经历了彻底的底层重构，从单一的图片获取工具，进化为**支持多指令分流、智能防超时、全网 API 兼容**的高级图片引擎。

<img width="1408" height="768" alt="image_602ec539-0c6a-426f-877a-8dcd374be08c" src="https://github.com/user-attachments/assets/8a5c7712-ff32-44d3-b051-7b881f3e16a2" />

## ✨ 插件变化

*   **从“单源”到“多源分流”**：告别写死单一 API，现支持在 WebUI 面板动态添加无数个图源，不同指令触发不同图库（如 `/img` 看动漫，`/cat` 看猫猫）。
*   **从“链接直发”到“本地缓存”**：彻底解决防盗链和裂图问题，图片先下载到本地再发送，发送完毕后 15 秒自动无痕清理。
*   **从“听天由命”到“智能容错”**：新增 **失败自动重试** 与 **原图直链兜底** 机制，彻底终结“网络超时就报错”的痛点。
*   **从“频繁超时”到“智能压缩”**：引入大图检测，QQ 端发不出的超大图片会自动压缩发送，兼顾速度与成功率。
*   **从“大模型插嘴”到“自动静音”**：完美接入 AstrBot 事件总线，触发发图指令后自动阻断大模型回复，不再自言自语。

---

## 🌟 功能特点

*   **🌐 全能 API 兼容**：内置智能 JSON 寻址算法，无论 API 结构多复杂，自动提取真实图片地址；完美兼容 302 跳转直链与纯图片流。
*   **🎛️ 强大的 Web 可视化配置**：基于 AstrBot 最新的 `template_list` 架构，在后台只需点击“添加”，即可轻松配置多组指令与 API。
*   **⚡ 自动压缩防超时**：内置 `Pillow` 引擎，可自定义“压缩阈值”（如 >5MB 自动压缩），极大提升大图发送成功率。
*   **🛡️ 极致兜底机制**：发送失败自动重试；如果重试上限耗尽（如文件极大/网络极差），自动降级发送带有 **原图链接** 的文本消息，绝不错过任何一张好图。
*   **⏱️ 冷却防刷屏**：内置用户级冷却计时器，保护你的 API 不被群友刷爆。

---

## 📦 安装方法

1. 下载插件代码压缩包，解压后重命名文件夹为 `astrbot_plugin_endworld_img_api`。
2. 将文件夹放置于 AstrBot 的 `data/plugins/` 目录下。
3. 安装额外的 Python 依赖库（在终端运行）：
   ```bash
   pip install aiofiles aiohttp Pillow
   ```
4. 重启 AstrBot 即可自动加载并在 Web 面板生成配置项。

---

## 🚀 使用说明 & 配置指南

### 1. 添加图源
进入 AstrBot 管理后台 -> 插件配置 -> 找到 `astrbot_plugin_endworld_img_api`。
* 点击 **“添加 单条规则”**。
* **规则名称**：随便起，如“随机涩涩”。
* **触发指令**：输入你想要的触发词，多个用逗号分隔（如 `涩涩, 猫猫`）。
* **API 地址**：输入对应的 API 链接。插件会按顺序尝试，优先请求第一个。*(如果 API 需要 GET 参数，可直接写在链接里，如 `http://api.com/img?type=1`)*

### 2. 用户日常指令
* 用户在群聊发送你在后台配置的触发词（如 `/涩涩`）。
* 机器人会自动下载图片、发送，并在控制台无痕清理缓存。

---

## ⚙️ 核心配置项解析

| 配置项 | 默认值 | 说明 |
| :--- | :--- | :--- |
| **发送失败重试次数** | `3` | 发送遇到网络波动时重试的次数，耗尽后将发送原图直链。 |
| **开启大图自动压缩** | `true` | 是否允许插件压缩超大图片以保证发送成功率。 |
| **压缩阈值 (MB)** | `5` | 图片体积大于此值才会触发压缩。想强制发原图可设为 `50`。 |
| **全局冷却时间 (秒)** | `10` | 限制单个用户连续请求的频率，防止刷屏。 |
| **验证 SSL 证书** | `false` | 关闭以兼容使用自签名证书的小众图片 API。 |

---

## ⚠️ 注意事项 & 提示

* **缓存机制**：图片下载后会暂存在 `data/temp_images/` 目录下。插件设计为发送完成后 15 秒自动删除，但在极特殊的强行关闭机器人情况下，该目录下可能会残留文件，可定期手动清空。
* **纯文本 fallback**：当你看到机器人回复 `⚠️ 发送失败(重试3次)，原图直链：...` 时，说明 QQ 协议端（如 NapCat）在规定的 30 秒内未能将该图片上传至腾讯服务器。直接点击链接即可查看原图。
* **法律警告**：本插件仅作为网络图片 API 的分发与转发工具。**请遵守相关法律法规，严禁在公开群聊对接与传播非法、违禁的图片源。使用者需自行承担因图源配置不当引发的封号或法律风险。**

---

## 🛠️ 开发维护

* **版本号**：v4.9 (Pro Edition)
* **衍生自**：(https://github.com/MCYUNIDC/mccloud_img) (Author: MC云)
* **当前重构作者**：殇之冥歌
* **核心依赖**：`AstrBot Core v4.10+`

🎉 **Enjoy your high-quality random images!** 🌸
